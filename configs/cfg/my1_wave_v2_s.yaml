# WaveEncoderBlockV2 配置 - 自适应波动传播（物理动机）
# 
# 核心改进（通用于所有密集检测场景）：
# 1. 物理自适应：根据场景特征动态调节波动参数α和c
#    - 密集场景：小α保留高频细节，大c快速聚合局部信息
#    - 稀疏场景：大α平滑背景噪声，小c避免过度扩散
# 
# 2. 特征增强：SMFA风格自调制（alpha×特征 + belt×方差）
# 
# 技术参考：Dynamic-CBAM (ICAMCS 2024) + SMFA (ECCV 2024)
# 适用场景：人群检测、车辆检测、农作物检测等任何密集目标场景

backbone:
  # [from, module, args]
  - [-1, StemBlock, [16, 16, True]] # 0-P2/4
  - [-1, HG_Stage, [16, 64, 1, 3, False, False, 3, True, 'se']] # 1-P2/4
  - [-1, HG_Stage, [32, 256, 1, 3, True, False, 3, True, 'se']] # 2-P3/8
  - [-1, HG_Stage, [64, 512, 2, 3, True, True, 5, True, 'se']]  # 3-P4/16
  - [-1, HG_Stage, [128, 1024, 1, 3, True, True, 5, True, 'se']] # 4-P5/32

encoder:
  - [2, ConvNormLayer_fuse, [256, 1, 1]] # 5-P3/8
  - [3, ConvNormLayer_fuse, [256, 1, 1]] # 6-P4/16
  - [4, ConvNormLayer_fuse, [256, 1, 1]] # 7-P5/32

  # 改进版：WaveEncoderBlockV2（动态参数 + 自调制）
  # 参数：[nhead, dim_feedforward, dropout, activation, pe_temperature, normalize_before]
  # 接口与WaveEncoderBlock/TransformerEncoderBlock完全一致
  - [-1, WaveEncoderBlockV2, [8, 1024, 0.1, "relu", 10000, False]] # 8-P5/32

  - [-1, ConvNormLayer_fuse, [256, 1, 1]] # 9
  - [-1, nn.Upsample, [None, 2, "nearest"]] # 10
  - [[-1, 6], Concat, []] # 11-P4/16
  - [-1, RepNCSPELAN4, [256, 512, 64, 1, False, 'silu']] # 12-P4/16

  - [-1, ConvNormLayer_fuse, [256, 1, 1]] # 13
  - [-1, nn.Upsample, [None, 2, "nearest"]] # 14
  - [[-1, 5], Concat, []] # 15-P3/8
  - [-1, RepNCSPELAN4, [256, 512, 64, 1, False, 'silu']] # 16-P3/8

  - [-1, SCDown, [256, 3, 2, 'silu']] # 17-P4/16
  - [[-1, 13], Concat, []] # 18-P4/16
  - [-1, RepNCSPELAN4, [256, 512, 64, 1, False, 'silu']] # 19-P4/16

  - [-1, SCDown, [256, 3, 2, 'silu']] # 20-P5/32
  - [[-1, 9], Concat, []] # 21-P5/32
  - [-1, RepNCSPELAN4, [256, 512, 64, 1, False, 'silu']] # 22-P5/32

decoder:
  - [[16, 19, 22], DFINETransformer, {"feat_strides":[8, 16, 32], "hidden_dim": 256, "num_levels": 3, "num_layers": 3, "num_points": [3, 6, 3], "dim_feedforward": 1024}]
